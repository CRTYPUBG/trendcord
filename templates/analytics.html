{% extends "base.html" %}

{% block title %}Analitik - Trendyol Bot{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <style>
        .trend-up { color: #dc3545; }
        .trend-down { color: #198754; }
        .trend-stable { color: #6c757d; }
        .deal-card { border-left: 4px solid #198754; }
        .alert-card { border-left: 4px solid #ffc107; }
        .stats-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
    </style>
    <!-- Page Header -->
    <div class="mb-8">
        <h1 class="text-3xl font-bold text-base-content">
            <i class="fas fa-chart-line mr-3 text-primary"></i>Analitik Dashboard
        </h1>
        <p class="text-base-content/70 mt-2">Fiyat trendleri, fırsatlar ve detaylı analizler</p>
    </div>
    <!-- Sunucu Seçimi ve İstatistikler -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
        <!-- Sunucu Seçimi -->
        <div class="card bg-base-200 shadow-lg">
            <div class="card-body">
                <h2 class="card-title text-lg">
                    <i class="fas fa-server text-primary"></i>
                    Sunucu Seçimi
                </h2>
                <select class="select select-bordered w-full" id="guildSelect" onchange="changeGuild()">
                    <option value="">Tüm Sunucular</option>
                    {% for guild in all_guild_stats %}
                    <option value="{{ guild.guild_id }}" {% if guild.guild_id == current_guild %}selected{% endif %}>
                        Sunucu {{ guild.guild_id }} ({{ guild.product_count }} ürün)
                    </option>
                    {% endfor %}
                </select>
            </div>
        </div>

        <!-- İstatistikler -->
        <div class="card bg-gradient-to-r from-primary to-secondary text-primary-content shadow-lg">
            <div class="card-body text-center">
                <h2 class="card-title justify-center text-lg mb-4">
                    <i class="fas fa-chart-pie"></i>
                    Seçili Sunucu İstatistikleri
                </h2>
                {% if guild_stats %}
                <div class="grid grid-cols-3 gap-4">
                    <div class="stat">
                        <div class="stat-value text-2xl">{{ guild_stats.total_products }}</div>
                        <div class="stat-desc text-primary-content/70">Toplam Ürün</div>
                    </div>
                    <div class="stat">
                        <div class="stat-value text-2xl">₺{{ "%.2f"|format(guild_stats.average_price) }}</div>
                        <div class="stat-desc text-primary-content/70">Ortalama Fiyat</div>
                    </div>
                    <div class="stat">
                        <div class="stat-value text-2xl">{{ guild_stats.products_added_today }}</div>
                        <div class="stat-desc text-primary-content/70">Bugün Eklenen</div>
                    </div>
                </div>
                {% else %}
                <p class="text-primary-content/70">Sunucu seçin veya veri bulunmuyor</p>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- En İyi Fırsatlar -->
    <div class="card bg-base-200 shadow-lg mb-8">
        <div class="card-header bg-success text-success-content">
            <h2 class="card-title text-lg">
                <i class="fas fa-fire"></i>
                En İyi Fırsatlar (Son 7 Gün)
            </h2>
        </div>
        <div class="card-body">
            {% if deals %}
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                {% for deal in deals %}
                <div class="card bg-base-100 shadow-md border-l-4 border-success">
                    <div class="card-body">
                        <h3 class="card-title text-sm">{{ deal.name[:40] }}{% if deal.name|length > 40 %}...{% endif %}</h3>
                        <div class="mb-2">
                            <span class="line-through text-base-content/50">₺{{ "%.2f"|format(deal.old_price) }}</span>
                            <span class="font-bold text-success ml-2">₺{{ "%.2f"|format(deal.current_price) }}</span>
                        </div>
                        <div class="flex gap-2 mb-3">
                            <span class="badge badge-success">%{{ "%.1f"|format(deal.discount_percentage) }} İndirim</span>
                            <span class="badge badge-info">₺{{ "%.2f"|format(deal.savings) }} Tasarruf</span>
                        </div>
                        <a href="{{ deal.url }}" target="_blank" class="btn btn-outline btn-primary btn-sm">
                            <i class="fas fa-external-link-alt"></i> Ürüne Git
                        </a>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="text-center py-8">
                <i class="fas fa-shopping-cart text-4xl text-base-content/30 mb-4"></i>
                <p class="text-base-content/70">Şu anda aktif fırsat bulunmuyor.</p>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Fiyat Uyarıları -->
    <div class="card bg-base-200 shadow-lg mb-8">
        <div class="card-header bg-warning text-warning-content">
            <h2 class="card-title text-lg">
                <i class="fas fa-exclamation-triangle"></i>
                Fiyat Uyarıları (%10+ Değişim)
            </h2>
        </div>
        <div class="card-body">
            {% if alerts %}
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                {% for alert in alerts %}
                <div class="card bg-base-100 shadow-md border-l-4 border-warning">
                    <div class="card-body">
                        <h3 class="card-title text-sm">{{ alert.name[:40] }}{% if alert.name|length > 40 %}...{% endif %}</h3>
                        <div class="flex items-center gap-2 mb-2">
                            <span class="text-base-content/70">₺{{ "%.2f"|format(alert.previous_price) }}</span>
                            <i class="fas fa-arrow-right text-base-content/50"></i>
                            <span class="font-bold">₺{{ "%.2f"|format(alert.current_price) }}</span>
                        </div>
                        <div class="flex gap-2 mb-3">
                            {% if alert.alert_type == 'increase' %}
                            <span class="badge badge-error">
                                <i class="fas fa-arrow-up"></i> +%{{ "%.1f"|format(alert.change_percentage) }}
                            </span>
                            {% else %}
                            <span class="badge badge-success">
                                <i class="fas fa-arrow-down"></i> %{{ "%.1f"|format(alert.change_percentage) }}
                            </span>
                            {% endif %}
                            <span class="badge badge-neutral">₺{{ "%.2f"|format(alert.change_amount|abs) }}</span>
                        </div>
                        <a href="{{ alert.url }}" target="_blank" class="btn btn-outline btn-primary btn-sm">
                            <i class="fas fa-external-link-alt"></i> Ürüne Git
                        </a>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="text-center py-8">
                <i class="fas fa-bell text-4xl text-base-content/30 mb-4"></i>
                <p class="text-base-content/70">Şu anda önemli fiyat değişikliği bulunmuyor.</p>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Trend Grafiği -->
    <div class="card bg-base-200 shadow-lg mb-8">
        <div class="card-header bg-info text-info-content">
            <h2 class="card-title text-lg">
                <i class="fas fa-chart-line"></i>
                Fiyat Trend Analizi
            </h2>
        </div>
        <div class="card-body">
            <div class="mb-6">
                <label for="productSelect" class="label">
                    <span class="label-text font-semibold">Ürün Seçin:</span>
                </label>
                <select class="select select-bordered w-full" id="productSelect" onchange="loadProductTrend()">
                    <option value="">Ürün seçin...</option>
                </select>
            </div>
            
            <div id="trendChart" style="display: none;" class="mb-6">
                <canvas id="priceChart" class="w-full h-64"></canvas>
            </div>
            
            <div id="trendInfo" class="mt-6" style="display: none;">
                <div class="grid grid-cols-2 md:grid-cols-5 gap-4">
                    <div class="stat bg-base-100 rounded-lg p-4 text-center">
                        <div class="stat-title text-sm">Trend</div>
                        <div class="stat-value text-lg">
                            <span id="trendDirection" class="badge"></span>
                        </div>
                    </div>
                    <div class="stat bg-base-100 rounded-lg p-4 text-center">
                        <div class="stat-title text-sm">Değişim</div>
                        <div class="stat-value text-lg">
                            <span id="trendChange"></span>
                        </div>
                    </div>
                    <div class="stat bg-base-100 rounded-lg p-4 text-center">
                        <div class="stat-title text-sm">Ortalama</div>
                        <div class="stat-value text-lg">
                            <span id="trendAverage"></span>
                        </div>
                    </div>
                    <div class="stat bg-base-100 rounded-lg p-4 text-center">
                        <div class="stat-title text-sm">En Düşük</div>
                        <div class="stat-value text-lg">
                            <span id="trendMin"></span>
                        </div>
                    </div>
                    <div class="stat bg-base-100 rounded-lg p-4 text-center">
                        <div class="stat-title text-sm">En Yüksek</div>
                        <div class="stat-value text-lg">
                            <span id="trendMax"></span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}

{% block scripts %}
<script>
        let priceChart = null;

        function changeGuild() {
            const guildId = document.getElementById('guildSelect').value;
            const url = new URL(window.location);
            if (guildId) {
                url.searchParams.set('guild_id', guildId);
            } else {
                url.searchParams.delete('guild_id');
            }
            window.location.href = url.toString();
        }

        function loadProducts() {
            const guildId = document.getElementById('guildSelect').value;
            let url = '/api/products';
            if (guildId) {
                url += '?guild_id=' + guildId;
            }

            fetch(url)
                .then(response => response.json())
                .then(data => {
                    const select = document.getElementById('productSelect');
                    select.innerHTML = '<option value="">Ürün seçin...</option>';
                    
                    if (data.success && data.products && data.products.length > 0) {
                        data.products.forEach(product => {
                            const option = document.createElement('option');
                            option.value = product.product_id;
                            option.textContent = (product.name || 'İsimsiz Ürün').substring(0, 50) + (product.name && product.name.length > 50 ? '...' : '');
                            select.appendChild(option);
                        });
                    } else {
                        const option = document.createElement('option');
                        option.value = '';
                        option.textContent = 'Ürün bulunamadı';
                        select.appendChild(option);
                    }
                })
                .catch(error => {
                    console.error('Ürünler yüklenirken hata:', error);
                    const select = document.getElementById('productSelect');
                    select.innerHTML = '<option value="">Hata: Ürünler yüklenemedi</option>';
                });
        }

        function loadProductTrend() {
            const productId = document.getElementById('productSelect').value;
            if (!productId) {
                document.getElementById('trendChart').style.display = 'none';
                document.getElementById('trendInfo').style.display = 'none';
                return;
            }

            // Loading göster
            const chartDiv = document.getElementById('trendChart');
            chartDiv.style.display = 'block';
            chartDiv.innerHTML = '<div class="text-center py-8"><span class="loading loading-spinner loading-lg"></span><p class="mt-2">Trend verisi yükleniyor...</p></div>';

            fetch(`/api/product_trend/${productId}?days=30`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success && data.trend) {
                        // Canvas'ı geri yükle
                        chartDiv.innerHTML = '<canvas id="priceChart" class="w-full h-64"></canvas>';
                        displayTrendChart(data.trend);
                        displayTrendInfo(data.trend);
                    } else {
                        chartDiv.innerHTML = '<div class="alert alert-error"><span>Trend verisi yüklenemedi: ' + (data.error || 'Bilinmeyen hata') + '</span></div>';
                        document.getElementById('trendInfo').style.display = 'none';
                    }
                })
                .catch(error => {
                    console.error('Trend verisi yüklenirken hata:', error);
                    chartDiv.innerHTML = '<div class="alert alert-error"><span>Trend verisi yüklenirken hata oluştu: ' + error.message + '</span></div>';
                    document.getElementById('trendInfo').style.display = 'none';
                });
        }

        function displayTrendChart(trendData) {
            const ctx = document.getElementById('priceChart').getContext('2d');
            
            if (priceChart) {
                priceChart.destroy();
            }

            const labels = trendData.price_history.map(item => {
                const date = new Date(item[0]);
                return date.toLocaleDateString('tr-TR');
            });
            
            const prices = trendData.price_history.map(item => item[1]);

            priceChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Fiyat (₺)',
                        data: prices,
                        borderColor: trendData.trend === 'up' ? '#dc3545' : trendData.trend === 'down' ? '#198754' : '#6c757d',
                        backgroundColor: trendData.trend === 'up' ? 'rgba(220, 53, 69, 0.1)' : trendData.trend === 'down' ? 'rgba(25, 135, 84, 0.1)' : 'rgba(108, 117, 125, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: false,
                            ticks: {
                                callback: function(value) {
                                    return '₺' + value.toFixed(2);
                                }
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return 'Fiyat: ₺' + context.parsed.y.toFixed(2);
                                }
                            }
                        }
                    }
                }
            });

            document.getElementById('trendChart').style.display = 'block';
        }

        function displayTrendInfo(trendData) {
            const trendDirection = document.getElementById('trendDirection');
            const trendChange = document.getElementById('trendChange');
            const trendAverage = document.getElementById('trendAverage');
            const trendMin = document.getElementById('trendMin');
            const trendMax = document.getElementById('trendMax');

            // Trend yönü
            if (trendData.trend === 'up') {
                trendDirection.className = 'badge bg-danger';
                trendDirection.innerHTML = '<i class="fas fa-arrow-up"></i> Yükseliş';
            } else if (trendData.trend === 'down') {
                trendDirection.className = 'badge bg-success';
                trendDirection.innerHTML = '<i class="fas fa-arrow-down"></i> Düşüş';
            } else {
                trendDirection.className = 'badge bg-secondary';
                trendDirection.innerHTML = '<i class="fas fa-arrow-right"></i> Stabil';
            }

            // Değişim yüzdesi
            trendChange.textContent = (trendData.change_percentage > 0 ? '+' : '') + trendData.change_percentage.toFixed(1) + '%';
            trendChange.className = trendData.change_percentage > 0 ? 'text-danger fw-bold' : trendData.change_percentage < 0 ? 'text-success fw-bold' : 'text-muted fw-bold';

            // Diğer bilgiler
            trendAverage.textContent = '₺' + trendData.average_price.toFixed(2);
            trendMin.textContent = '₺' + trendData.min_price.toFixed(2);
            trendMax.textContent = '₺' + trendData.max_price.toFixed(2);

            document.getElementById('trendInfo').style.display = 'block';
        }

        // Sayfa yüklendiğinde ürünleri yükle
        document.addEventListener('DOMContentLoaded', function() {
            loadProducts();
        });
</script>
{% endblock %}