{% extends "base.html" %}

{% block title %}Analitik - Trendyol Bot{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <!-- Page Header -->
    <div class="mb-8">
        <h1 class="text-3xl font-bold text-base-content">
            <i class="fas fa-chart-line mr-3"></i>
            Analitik Dashboard
        </h1>
        <p class="text-base-content/70 mt-2">Fiyat trendleri ve istatistikler</p>
    </div>

    <!-- Sunucu Seçimi -->
    <div class="card bg-base-200 shadow-lg mb-8">
        <div class="card-body">
            <h2 class="card-title text-lg">
                <i class="fas fa-server mr-2"></i>
                Sunucu Seçimi
            </h2>
            <select class="select select-bordered w-full max-w-xs" onchange="changeGuild()">
                <option value="">Tüm Sunucular</option>
                {% for guild in guilds %}
                <option value="{{ guild.guild_id }}" {% if guild.guild_id|string == selected_guild|string %}selected{% endif %}>
                    Sunucu {{ guild.guild_id }} ({{ guild.product_count }} ürün)
                </option>
                {% endfor %}
            </select>
        </div>
    </div>

    <!-- İstatistikler -->
    {% if guild_stats %}
    <div class="card bg-gradient-to-r from-primary to-secondary text-primary-content shadow-lg mb-8">
        <div class="card-body">
            <h2 class="card-title text-xl mb-4">
                <i class="fas fa-chart-bar mr-2"></i>
                Genel İstatistikler
            </h2>
            <div class="stats stats-vertical lg:stats-horizontal shadow">
                <div class="stat">
                    <div class="stat-title text-primary-content/70">Toplam Ürün</div>
                    <div class="stat-value text-2xl">{{ guild_stats.total_products }}</div>
                    <div class="stat-desc text-primary-content/70">Takip edilen</div>
                </div>
                <div class="stat">
                    <div class="stat-title text-primary-content/70">Ortalama Fiyat</div>
                    <div class="stat-value text-2xl">₺{{ "%.0f"|format(guild_stats.avg_price) }}</div>
                    <div class="stat-desc text-primary-content/70">Genel ortalama</div>
                </div>
                <div class="stat">
                    <div class="stat-title text-primary-content/70">Bugün Eklenen</div>
                    <div class="stat-value text-2xl">{{ guild_stats.today_added }}</div>
                    <div class="stat-desc text-primary-content/70">Yeni ürün</div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- En İyi Fırsatlar -->
    <div class="card bg-base-200 shadow-lg mb-8">
        <div class="card-header bg-success text-success-content p-4">
            <h2 class="card-title text-xl">
                <i class="fas fa-fire mr-2"></i>
                En İyi Fırsatlar (%20+ İndirim)
            </h2>
        </div>
        <div class="card-body">
            {% if deals %}
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                {% for deal in deals %}
                <div class="card bg-base-100 shadow-md">
                    <div class="card-body">
                        <h3 class="card-title text-sm">{{ deal.name[:50] }}...</h3>
                        <div class="mb-2">
                            <span class="line-through text-base-content/50">₺{{ "%.2f"|format(deal.original_price) }}</span>
                            <span class="font-bold text-success ml-2">₺{{ "%.2f"|format(deal.current_price) }}</span>
                        </div>
                        <div class="flex justify-between items-center mb-3">
                            <span class="badge badge-success">%{{ "%.0f"|format(deal.discount_percentage) }} İndirim</span>
                            <span class="text-xs text-base-content/70">{{ deal.last_updated }}</span>
                        </div>
                        <a href="{{ deal.url }}" target="_blank" class="btn btn-sm btn-primary">
                            <i class="fas fa-external-link-alt"></i> Ürüne Git
                        </a>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="text-center py-8">
                <i class="fas fa-shopping-cart text-4xl text-base-content/30 mb-4"></i>
                <p class="text-base-content/70">Şu anda aktif fırsat bulunmuyor.</p>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Fiyat Uyarıları -->
    <div class="card bg-base-200 shadow-lg mb-8">
        <div class="card-header bg-warning text-warning-content p-4">
            <h2 class="card-title text-xl">
                <i class="fas fa-exclamation-triangle mr-2"></i>
                Fiyat Uyarıları (%10+ Değişim)
            </h2>
        </div>
        <div class="card-body">
            {% if alerts %}
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                {% for alert in alerts %}
                <div class="card bg-base-100 shadow-md">
                    <div class="card-body">
                        <h3 class="card-title text-sm">{{ alert.name[:50] }}...</h3>
                        <div class="flex items-center mb-2">
                            <span class="text-base-content/70">₺{{ "%.2f"|format(alert.old_price) }}</span>
                            <i class="fas fa-arrow-right mx-2"></i>
                            <span class="font-bold">₺{{ "%.2f"|format(alert.new_price) }}</span>
                        </div>
                        <div class="flex justify-between items-center mb-3">
                            {% if alert.change_type == 'increase' %}
                            <span class="badge badge-error">
                                <i class="fas fa-arrow-up mr-1"></i> %{{ "%.1f"|format(alert.change_percentage) }}
                            </span>
                            {% else %}
                            <span class="badge badge-success">
                                <i class="fas fa-arrow-down mr-1"></i> %{{ "%.1f"|format(alert.change_percentage) }}
                            </span>
                            {% endif %}
                            <span class="badge badge-neutral">₺{{ "%.2f"|format(alert.change_amount|abs) }}</span>
                        </div>
                        <a href="{{ alert.url }}" target="_blank" class="btn btn-sm btn-primary">
                            <i class="fas fa-external-link-alt"></i> Ürüne Git
                        </a>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="text-center py-8">
                <i class="fas fa-bell text-4xl text-base-content/30 mb-4"></i>
                <p class="text-base-content/70">Şu anda önemli fiyat değişikliği bulunmuyor.</p>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Basit Trend Analizi -->
    <div class="card bg-base-200 shadow-lg mb-8">
        <div class="card-header bg-info text-info-content p-4">
            <h2 class="card-title text-xl">
                <i class="fas fa-chart-line mr-2"></i>
                Trend Analizi
            </h2>
        </div>
        <div class="card-body">
            <div class="form-control w-full max-w-xs mb-4">
                <label class="label">
                    <span class="label-text">Ürün Seçin</span>
                </label>
                <select class="select select-bordered" id="productSelect" onchange="loadProductTrend()">
                    <option value="">Ürün seçin...</option>
                </select>
            </div>
            
            <div class="hidden" id="trendResult">
                <div class="alert alert-info mb-4">
                    <i class="fas fa-info-circle"></i>
                    <span id="trendMessage">Trend analizi yükleniyor...</span>
                </div>
                
                <div class="stats stats-vertical lg:stats-horizontal shadow w-full">
                    <div class="stat bg-base-100 rounded-lg p-4 text-center">
                        <div class="stat-title text-sm">Trend Yönü</div>
                        <div class="stat-value text-lg">
                            <span id="trendDirection" class="badge badge-neutral">-</span>
                        </div>
                    </div>
                    <div class="stat bg-base-100 rounded-lg p-4 text-center">
                        <div class="stat-title text-sm">Değişim</div>
                        <div class="stat-value text-lg">
                            <span id="trendChange">-</span>
                        </div>
                    </div>
                    <div class="stat bg-base-100 rounded-lg p-4 text-center">
                        <div class="stat-title text-sm">Ortalama Fiyat</div>
                        <div class="stat-value text-lg">
                            <span id="trendAverage">-</span>
                        </div>
                    </div>
                    <div class="stat bg-base-100 rounded-lg p-4 text-center">
                        <div class="stat-title text-sm">Veri Noktası</div>
                        <div class="stat-value text-lg">
                            <span id="trendPoints">-</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    function changeGuild() {
        const guildId = document.querySelector('select').value;
        const url = new URL(window.location);
        if (guildId) {
            url.searchParams.set('guild_id', guildId);
        } else {
            url.searchParams.delete('guild_id');
        }
        window.location.href = url.toString();
    }

    function loadProducts() {
        const guildId = new URLSearchParams(window.location.search).get('guild_id');
        let url = '/api/products';

        if (guildId) {
            url += '?guild_id=' + guildId;
        }

        fetch(url)
            .then(response => response.json())
            .then(data => {
                const select = document.getElementById('productSelect');
                select.innerHTML = '<option value="">Ürün seçin...</option>';
                
                if (data.success && data.products) {
                    data.products.forEach(product => {
                        const option = document.createElement('option');
                        option.value = product.product_id;
                        option.textContent = product.name.substring(0, 50) + '...';
                        select.appendChild(option);
                    });
                } else {
                    const option = document.createElement('option');
                    option.value = '';
                    option.textContent = 'Ürün bulunamadı';
                    select.appendChild(option);
                }
            })
            .catch(error => {
                console.error('Ürünler yüklenirken hata:', error);
                showToast('Ürünler yüklenemedi: ' + error.message, 'error');
            });
    }

    function loadProductTrend() {
        const productId = document.getElementById('productSelect').value;
        const resultDiv = document.getElementById('trendResult');
        
        if (!productId) {
            resultDiv.classList.add('hidden');
            return;
        }

        // Loading göster
        resultDiv.classList.remove('hidden');
        document.getElementById('trendMessage').textContent = 'Trend analizi yükleniyor...';

        fetch(`/api/products/${productId}/trend`)
            .then(response => response.json())
            .then(data => {
                if (data.success && data.trend) {
                    displayTrendInfo(data.trend);
                } else {
                    document.getElementById('trendMessage').textContent = 'Trend verisi alınamadı: ' + (data.error || 'Bilinmeyen hata');
                }
            })
            .catch(error => {
                console.error('Trend verisi yüklenirken hata:', error);
                document.getElementById('trendMessage').textContent = 'Bağlantı hatası: ' + error.message;
            });
    }

    function displayTrendInfo(trendData) {
        // Mesajı gizle
        document.getElementById('trendMessage').textContent = 'Trend analizi tamamlandı';

        const trendDirection = document.getElementById('trendDirection');
        const trendChange = document.getElementById('trendChange');
        const trendAverage = document.getElementById('trendAverage');
        const trendPoints = document.getElementById('trendPoints');

        // Trend yönü
        if (trendData.trend === 'up') {
            trendDirection.className = 'badge badge-error';
            trendDirection.innerHTML = '<i class="fas fa-arrow-up mr-1"></i> Artış';
        } else if (trendData.trend === 'down') {
            trendDirection.className = 'badge badge-success';
            trendDirection.innerHTML = '<i class="fas fa-arrow-down mr-1"></i> Düşüş';
        } else if (trendData.trend === 'stable') {
            trendDirection.className = 'badge badge-neutral';
            trendDirection.innerHTML = '<i class="fas fa-minus mr-1"></i> Stabil';
        } else {
            trendDirection.className = 'badge badge-ghost';
            trendDirection.innerHTML = '<i class="fas fa-question mr-1"></i> Yetersiz Veri';
        }

        // Değişim
        const changePercentage = trendData.change_percentage || 0;
        trendChange.textContent = (changePercentage > 0 ? '+' : '') + changePercentage.toFixed(1) + '%';
        trendChange.className = changePercentage > 0 ? 'text-error font-bold' : changePercentage < 0 ? 'text-success font-bold' : 'text-base-content font-bold';

        // Diğer bilgiler
        trendAverage.textContent = '₺' + (trendData.average_price || 0).toFixed(2);
        trendPoints.textContent = trendData.data_points || 0;
    }

    function showToast(message, type = 'info') {
        // Basit toast notification
        const toast = document.createElement('div');
        toast.className = `toast toast-top toast-end`;
        toast.innerHTML = `
            <div class="alert alert-${type}">
                <span>${message}</span>
            </div>
        `;
        document.body.appendChild(toast);
        
        setTimeout(() => {
            toast.remove();
        }, 3000);
    }

    // Sayfa yüklendiğinde ürünleri yükle
    document.addEventListener('DOMContentLoaded', function() {
        loadProducts();
    });
</script>
{% endblock %}